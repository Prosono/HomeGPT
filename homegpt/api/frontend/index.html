<!DOCTYPE html>
<html lang="en">
<head>
  <!-- =====================================================================
       META & TITLE
       ===================================================================== -->
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>SMARTi Spectra</title>

  <!-- =====================================================================
       PRECONNECTS (speed up CDNs)
       ===================================================================== -->
  <link rel="preconnect" href="https://cdn.tailwindcss.com" crossorigin>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>

  <!-- =====================================================================
       UI LIBS (Tailwind, Marked, Chart.js, Icons)
       Note: scripts use `defer` where possible to avoid blocking render.
       ===================================================================== -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
  <link rel="stylesheet" href="https://cdn.materialdesignicons.com/7.2.96/css/materialdesignicons.min.css">

  <!-- =====================================================================
       APP STYLES
       ===================================================================== -->
  <link rel="stylesheet" href="static/style.css" />

  <!-- =====================================================================
       SAFETY: ensure <dialog> elements are hidden unless opened via JS
       (prevents any global .modal class from forcing visibility)
       ===================================================================== -->
  <style>
    dialog:not([open]) { display: none; }
  </style>
</head>

<body class="bg-gray-900 text-gray-200 font-sans antialiased selection:bg-indigo-600/30 selection:text-white">
  <!-- =====================================================================
       BACKGROUNDS
       - Particles canvas (behind content)
       - Aurora blobs (decorative)
       ===================================================================== -->
  <div id="particles-js" aria-hidden="true"></div>

  <div class="aurora" aria-hidden="true">
    <span class="blob b1"></span>
    <span class="blob b2"></span>
    <span class="blob b3"></span>
    <span class="blob b4"></span>
    <span class="blob b5"></span>
  </div>

  <!-- =====================================================================
       MAIN APP WRAPPER
       ===================================================================== -->
  <main class="max-w-6xl mx-auto p-6">
    <div class="card rounded-xl shadow-xl p-8">
      <!-- ================================================================
           MASTHEAD (brand, mode, stats)
           ================================================================ -->
      <header class="masthead">
        <!-- Left cluster: mode & model -->
        <div class="mast-left">
          <button id="toggleMode" class="btn-ghost mast-pill" aria-live="polite">
            <i class="mdi mdi-robot" aria-hidden="true"></i>
            <span id="modeName">passive</span>
          </button>

          <span class="chip mast-pill" aria-live="polite">
            <i class="mdi mdi-cpu-64-bit" aria-hidden="true"></i>
            <span id="modelName">Model</span>
          </span>
        </div>

        <!-- Center: logo -->
        <div class="mast-center">
          <a href="/" class="logo-wrap" aria-label="Spectra Home">
            <picture>
              <source srcset="static/spectra-logo-dark.png" media="(prefers-color-scheme: dark)" />
              <img
                src="static/spectra-logo-light.png"
                alt="Spectra logo"
                width="160"
                height="48"
                decoding="async"
                loading="eager"
              />
            </picture>
            <div class="tagline">Smart Living, Simplified</div>
          </a>
        </div>

        <!-- Right cluster: live stats -->
        <div class="mast-right">
          <span class="stat" aria-live="polite">
            <i class="mdi mdi-bell-outline" aria-hidden="true"></i>
            <span id="eventCount">0 events</span>
          </span>
          <span class="stat" aria-live="polite">
            <i class="mdi mdi-clock-outline" aria-hidden="true"></i>
            <span id="sinceLast">—</span>
          </span>
        </div>
      </header>

      <!-- ================================================================
           PRIMARY ACTIONS (history analysis, start analysis, feedback manager)
           ================================================================ -->
      <div class="actions-bar">
        <div class="actions-left">
          <button id="btn-analyze-history" class="btn-ghost lg">
            <i class="mdi mdi-history" aria-hidden="true"></i>
            Analyse history
          </button>
        </div>

        <div class="actions-right">
          <button id="runAnalysis" class="btn">
            <i class="mdi mdi-play" aria-hidden="true"></i>
            Start New Analysis
          </button>
          <button id="btn-manage-feedback" class="btn-ghost" aria-haspopup="dialog" aria-controls="dlg-manage-feedback">
            <i class="mdi mdi-note-edit-outline" aria-hidden="true"></i>
            Manage feedback
          </button>
        </div>
      </div>

      <!-- ================================================================
           PROGRESS BAR
           ================================================================ -->
      <div class="mb-6" aria-live="polite">
        <div class="w-full bg-gray-700/70 h-3 rounded-full overflow-hidden">
          <div
            id="progressBar"
            class="bg-gradient-to-r from-purple-500 to-pink-500 h-3 rounded-full transition-all duration-500"
            style="width:0%"
            aria-label="Analysis progress"
            role="progressbar"
            aria-valuemin="0"
            aria-valuemax="100"
            aria-valuenow="0"
          ></div>
        </div>
      </div>


        <!-- ================================================================
        Spectra Ask
        ================================================================ -->
      <div class="ask-card card" id="askCard">
        <div class="ask-row">
          <input id="askInput" class="ask-input" placeholder="Ask Spectra about your home…">
          <button id="askSend" class="btn">Ask</button>
        </div>

        <!-- subtle status line with animation -->
        <div class="ask-status" id="askStatus" aria-live="polite" aria-atomic="true"></div>

        <!-- reply container -->
        <div id="askResult" class="ask-result hidden" aria-live="polite"></div>
        <br>
        <br>
      </div>



      <!-- ================================================================
           EVENTS (last 24h)
           ================================================================ -->
      <section class="mb-6" aria-labelledby="events-title">
        <div class="section-head">
          <h2 id="events-title">Events</h2>
          <div class="sub">Auto-extracted from analyses</div>
        </div>

        <!-- Filled dynamically by app.js -->
        <div id="eventsList" class="text-sm"></div>

        <!-- Pager (prev/next injected) -->
        <div id="eventsPager" aria-label="Events pagination"></div>
      </section>

      <!-- ================================================================
           FEEDBACK MANAGER (dialog)
           - Hidden until opened via JS `showModal()`
           ================================================================ -->
      <dialog id="dlg-manage-feedback" aria-labelledby="fbm-title">
        <!-- Header -->
        <div class="fbm-head">
          <h2 id="fbm-title">Feedback Manager</h2>
          <button id="fbm-close" class="close-x" aria-label="Close feedback manager">
            <i class="mdi mdi-close" aria-hidden="true"></i>
          </button>
        </div>

        <!-- Body -->
        <div class="fbm-body">
          <!-- Toolbar / Filters -->
          <div class="fbm-controls">
            <input id="fbm-search" class="fbm-input" placeholder="Search notes, bodies, entities…" />
            <input id="fbm-entity" class="fbm-input" placeholder="Filter by entity_id (e.g. sensor.power)" />
            <select id="fbm-category" class="fbm-input" aria-label="Filter by category">
              <option value="">All categories</option>
              <option>security</option>
              <option>comfort</option>
              <option>energy</option>
              <option>anomalies</option>
              <option>presence</option>
            </select>
            <button id="fbm-refresh" class="fbm-btn">Refresh</button>
          </div>

          <!-- Results list (cards injected here) -->
          <div id="fbm-list" aria-live="polite"></div>
        </div>
      </dialog>

      <!-- ================================================================
           EDIT FEEDBACK (dialog)
           ================================================================ -->
      <dialog id="dlg-edit-feedback" aria-labelledby="fbe-title">
        <div class="fbm-head">
          <h2 id="fbe-title">Edit feedback</h2>
          <button id="fbe-cancel" class="close-x" aria-label="Close edit feedback">
            <i class="mdi mdi-close" aria-hidden="true"></i>
          </button>
        </div>

        <div class="fbm-body fbe-wrap">
          <input id="fbe-id" type="hidden" />

          <div id="fbe-meta" class="text-sm"></div>

          <label for="fbe-note" class="block text-sm mb-1">Note</label>
          <textarea id="fbe-note" rows="4"></textarea>

          <label for="fbe-kind" class="block text-sm mt-2 mb-1">Kind</label>
          <select id="fbe-kind">
            <option value="context">context</option>
            <option value="correction">correction</option>
            <option value="preference">preference</option>
          </select>

          <div class="fbe-actions">
            <span id="fbe-result" class="text-sm"></span>
            <button id="fbe-delete" class="fbm-btn">Delete…</button>
            <button id="fbe-save" class="fbm-btn">Save</button>
          </div>
        </div>
      </dialog>

      <!-- ================================================================
          ANALYSIS HEATMAP (glow-up)
          ================================================================ -->

          <section class="mb-6" aria-labelledby="heatmap-title">
            <div class="section-head">
              <h2 id="heatmap-title">Analysis Heatmap</h2>
              <div class="sub">X: hour • Y: category • intensity = findings/severity</div>
            </div>

            <div class="heat-wrap">
              <!-- Heatmap card -->
              <div class="heat-card">
                <div id="analysisHeatmap" class="heatmap"></div>

                <!-- Footer: legend (left) + range (right) -->
                <div class="heat-footer">
                  <!-- Legend -->
                  <div class="hm-legend" aria-hidden="true">
                    <span>Low</span>
                    <i class="hm-swatch swatch-1"></i>
                    <i class="hm-swatch swatch-2"></i>
                    <i class="hm-swatch swatch-3"></i>
                    <i class="hm-swatch swatch-4"></i>
                    <i class="hm-swatch swatch-5"></i>
                    <span>High</span>
                  </div>

                  <!-- Range (moved under the heatmap) -->
                  <div class="hc-range">
                    <div class="hc-title">Range</div>
                    <div class="btn-toggle" role="group" aria-label="Time range">
                      <button class="chip" data-hm-range="24"  aria-pressed="false">24h</button>
                      <button class="chip" data-hm-range="48"  aria-pressed="true">48h</button>
                      <button class="chip" data-hm-range="168" aria-pressed="false">7d</button>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Controls (right) — now shorter: only severity + filters -->
              <aside class="heat-controls glass">
                <div class="hc-block">
                  <div class="hc-title flex items-center gap-2">
                    <span>Min severity</span>
                    <span id="hm-threshold-val" class="value">0</span>
                  </div>
                  <input id="hm-threshold" type="range" min="0" max="6" step="1" value="0" />
                </div>

                <div class="hc-block">
                  <div class="hc-title">Filter</div>
                  <div class="btn-toggle flex-wrap" role="group" aria-label="Category filter">
                    <button class="chip" data-hm-filter="all"        aria-pressed="true">All</button>
                    <button class="chip" data-hm-filter="security"   aria-pressed="false">Security</button>
                    <button class="chip" data-hm-filter="comfort"    aria-pressed="false">Comfort</button>
                    <button class="chip" data-hm-filter="energy"     aria-pressed="false">Energy</button>
                    <button class="chip" data-hm-filter="anomalies"  aria-pressed="false">Anomalies</button>
                  </div>
                </div>
              </aside>
            </div>
          </section>
    

      <!-- ================================================================
           ANALYSES GRID (cards are injected)
           ================================================================ -->
      <section aria-labelledby="analyses-title">
        <h2 id="analyses-title" class="sr-only">Analyses</h2>
        <div id="analysisGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
      </section>
    </div>
  </main>

  <!-- =====================================================================
       OVERLAY: Analysis details (custom modal, non-<dialog>)
       ===================================================================== -->
  <div id="detailsOverlay" class="fixed inset-0 z-50 hidden" aria-hidden="true">
    <div id="overlayBackdrop" class="absolute inset-0 bg-black/60"></div>

    <div class="absolute inset-0 flex items-center justify-center p-4">
      <div class="card modal-panel rounded-xl shadow-2xl p-6 relative w-full max-w-5xl" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
        <button id="modalClose" class="absolute top-3 right-3 text-gray-300 hover:text-white text-xl leading-none" aria-label="Close dialog">✕</button>

        <!-- Header -->
        <div class="space-y-2 mb-4">
          <h2 id="modalTitle" class="text-2xl font-bold text-indigo-300">Analysis</h2>
          <div id="modalMeta" class="text-sm text-gray-400"></div>
        </div>

        <!-- Legacy aliases (kept for backward-compat with old code) -->
        <h2 id="title" class="sr-only">Analysis</h2>
        <div id="meta" class="sr-only"></div>

        <!-- Hero -->
        <div class="modal-hero mb-6">
          <div class="hero-head">
            <i class="mdi mdi-home-analytics" aria-hidden="true"></i>
            Daily Summary
          </div>
          <div class="hero-body" id="modalIntro">Latest insights for your home.</div>
        </div>

        <!-- Summary body injected -->
        <div id="modalSummary" class="prose prose-invert max-w-none whitespace-pre-wrap leading-relaxed"></div>
        <div id="summary" class="sr-only"></div>
      </div>
    </div>
  </div>

  <!-- =====================================================================
       LEGACY ALIAS BRIDGE (syncs hidden legacy IDs with new ones)
       ===================================================================== -->
  <script>
    (function () {
      function ensureAlias(aliasId, primaryId) {
        const primary = document.getElementById(primaryId);
        if (!primary) return;

        let alias = document.getElementById(aliasId);
        if (!alias) {
          alias = document.createElement(primary.tagName || 'div');
          alias.id = aliasId;
          alias.className = 'sr-only';
          primary.parentNode.insertBefore(alias, primary);
        }

        const sync = () => { primary.innerHTML = alias.innerHTML; };
        new MutationObserver(sync).observe(alias, { childList: true, subtree: true, characterData: true });
        sync();
      }
      ensureAlias('title','modalTitle');
      ensureAlias('meta','modalMeta');
      ensureAlias('summary','modalSummary');
    })();
  </script>

  <!-- =====================================================================
       PARTICLES BACKGROUND
       ===================================================================== -->
  <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>
  <script>
    (function () {
      // Respect reduced motion
      if (window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches) return;

      particlesJS('particles-js', {
        particles: {
          number: { value: 70, density: { enable: true, value_area: 900 } },
          color: { value: ["#60a5fa", "#a78bfa", "#22d3ee", "#ec4899"] },
          shape: { type: "circle" },
          opacity: { value: 0.35, random: true },
          size: { value: 3, random: true },
          line_linked: { enable: true, distance: 130, color: "#8093b6", opacity: 0.25, width: 1 },
          move: { enable: true, speed: 1.1, direction: "none", random: true, straight: false, out_mode: "out", attract: { enable: false } }
        },
        interactivity: {
          detect_on: "canvas",
          events: {
            onhover: { enable: true, mode: "grab" },
            onclick: { enable: true, mode: "push" },
            resize: true
          },
          modes: {
            grab: { distance: 140, line_linked: { opacity: 0.45 } },
            bubble: { distance: 200, size: 6, duration: 2, opacity: 0.4, speed: 3 },
            push: { particles_nb: 3 }
          }
        },
        retina_detect: true
      });
    })();
  </script>

  <!-- =====================================================================
       APP LOGIC
       - Includes tiny dialog wiring so Feedback Manager stays hidden by default
       ===================================================================== -->
  <script>
    // Simple wiring for <dialog> open/close (kept here for clarity; can move to app.js)
    window.addEventListener('DOMContentLoaded', () => {
      const dlgManage = document.getElementById('dlg-manage-feedback');
      const dlgEdit   = document.getElementById('dlg-edit-feedback');

      // Open Feedback Manager
      document.getElementById('btn-manage-feedback')?.addEventListener('click', () => {
        if (typeof dlgManage.showModal === 'function') dlgManage.showModal();
        else dlgManage.setAttribute('open', ''); // fallback
      });

      // Close Feedback Manager
      document.getElementById('fbm-close')?.addEventListener('click', () => {
        dlgManage.close?.();
        dlgManage.removeAttribute('open');
      });

      // Close Edit Feedback via header X (acts as cancel)
      document.getElementById('fbe-cancel')?.addEventListener('click', () => {
        dlgEdit.close?.();
        dlgEdit.removeAttribute('open');
      });

      // Optional: close on backdrop click for both dialogs
      [dlgManage, dlgEdit].forEach(dlg => {
        dlg?.addEventListener('click', (e) => {
          const rect = dlg.getBoundingClientRect();
          const clickedOutside =
            e.clientX < rect.left || e.clientX > rect.right ||
            e.clientY < rect.top  || e.clientY > rect.bottom;
          if (clickedOutside) { dlg.close?.(); dlg.removeAttribute('open'); }
        });
      });
    });
  </script>

  <script src="static/app.js" defer></script>
</body>
</html>
