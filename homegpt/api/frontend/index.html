<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>SMARTi Spectra</title>

  <!-- Preconnects for faster CDNs -->
  <link rel="preconnect" href="https://cdn.tailwindcss.com" crossorigin>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>

  <!-- UI libs -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
  <link rel="stylesheet" href="https://cdn.materialdesignicons.com/7.2.96/css/materialdesignicons.min.css">

  <!-- App styles -->
  <link rel="stylesheet" href="static/style.css" />
</head>
<body class="bg-gray-900 text-gray-200 font-sans antialiased selection:bg-indigo-600/30 selection:text-white">

  <!-- Animated background (aurora blobs) -->
  <div class="aurora" aria-hidden="true">
    <span class="blob b1"></span>
    <span class="blob b2"></span>
    <span class="blob b3"></span>
    <span class="blob b4"></span>
    <span class="blob b5"></span>
  </div>

  <main class="max-w-6xl mx-auto p-6">
    <div class="card rounded-xl shadow-xl p-8">
      <!-- Header with logo + wordmark -->
      <header class="mb-8">
        <a href="/" class="flex items-center justify-center gap-3 select-none" aria-label="Spectra Home">
          <picture>
            <source srcset="static/spectra-logo-dark.png" media="(prefers-color-scheme: dark)" />
            <img
              src="static/spectra-logo-light.png"
              alt="Spectra logo"
              class="h-12 w-auto"
              width="160"
              height="48"
              decoding="async"
            />
          </picture>
        </a>
        <p class="mt-2 text-center text-sm text-gray-400">Smart Living, Simplified</p>
      </header>

      <!-- Top controls bar -->
      <div class="flex flex-wrap items-center justify-between mb-6 gap-4">
        <div class="flex items-center gap-3">
          <button id="toggleMode" class="btn btn-ghost" aria-live="polite">
            <i class="mdi mdi-robot"></i>
            <span>Mode: <span id="modeName">Loading…</span></span>
          </button>
          <span class="chip" aria-live="polite">
            <i class="mdi mdi-cpu-64-bit"></i>
            <span id="modelName">Model</span>
          </span>
        </div>

        <div class="flex-1"></div>

        <div class="flex items-center gap-3 text-sm sm:text-base">
          <span class="chip" aria-live="polite">
            <i class="mdi mdi-bell-outline"></i><span id="eventCount">0 events</span>
          </span>
          <span class="chip" aria-live="polite">
            <i class="mdi mdi-clock-outline"></i><span id="sinceLast">—</span>
          </span>
        </div>

        <div class="flex items-center gap-3">
          <button id="btn-analyze-history" class="btn btn-ghost">
            <i class="mdi mdi-history"></i>Analyse history
          </button>
          <button id="runAnalysis" class="btn">
            <i class="mdi mdi-play"></i>Start New Analysis
          </button>
        </div>
      </div>

      <!-- History range dialog -->
      <dialog id="dlg-history" class="card rounded-xl p-6 text-gray-200">
        <form method="dialog">
          <h3 class="text-lg font-extrabold mb-3">Select time range</h3>
          <div id="history-options" class="flex flex-wrap gap-2 mb-4"><!-- buttons injected by JS --></div>
          <div class="text-right">
            <button value="cancel" class="btn btn-ghost">
              <i class="mdi mdi-close"></i>Cancel
            </button>
          </div>
        </form>
      </dialog>

      <!-- Progress bar -->
      <div class="mb-6">
        <div class="w-full bg-gray-700/70 h-3 rounded-full overflow-hidden">
          <div id="progressBar" class="bg-gradient-to-r from-purple-500 to-pink-500 h-3 rounded-full transition-all duration-500" style="width:0%"></div>
        </div>
      </div>

      <!-- Analyses grid -->
      <div id="analysisGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
    </div>
  </main>

  <!-- Modal overlay -->
  <div id="detailsOverlay" class="fixed inset-0 z-50 hidden">
    <div id="overlayBackdrop" class="absolute inset-0 bg-black/60"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
      <div class="card modal-panel rounded-xl shadow-2xl p-6 relative w-full max-w-5xl">
        <button id="modalClose" class="absolute top-3 right-3 text-gray-300 hover:text-white text-xl leading-none" aria-label="Close dialog">✕</button>

        <!-- Visible title/meta -->
        <div class="space-y-2 mb-4">
          <h2 id="modalTitle" class="text-2xl font-bold text-indigo-300">Analysis</h2>
          <div id="modalMeta" class="text-sm text-gray-400"></div>
        </div>

        <!-- Hidden aliases so old code using #title/#meta keeps working -->
        <h2 id="title" class="sr-only">Analysis</h2>
        <div id="meta" class="sr-only"></div>

        <!-- Optional hero -->
        <div class="modal-hero mb-6">
          <div class="hero-head">
            <i class="mdi mdi-home-analytics"></i>
            Daily Summary
          </div>
          <div class="hero-body" id="modalIntro">Latest insights for your home.</div>
        </div>

        <!-- Category layout (optional; can be filled later) -->
        <div class="modal-masonry hidden" id="modalMasonry">
          <section class="modal-section theme-security">
            <h3><i class="mdi mdi-shield-home-outline"></i>Security</h3>
            <div class="section-body" id="secSecurity">Nothing to report.</div>
          </section>

          <section class="modal-section theme-comfort">
            <h3><i class="mdi mdi-thermometer"></i>Comfort</h3>
            <div class="section-body" id="secComfort">Nothing to report.</div>
            <div class="section-chart"><canvas id="chartTemp"></canvas></div>
          </section>

          <section class="modal-section theme-energy">
            <h3><i class="mdi mdi-flash"></i>Energy</h3>
            <div class="section-body" id="secEnergy">Nothing to report.</div>
          </section>

          <section class="modal-section theme-anomalies">
            <h3><i class="mdi mdi-alert-decagram-outline"></i>Anomalies</h3>
            <div class="section-body" id="secAnomalies">Nothing to report.</div>
          </section>

          <section class="modal-section theme-reco">
            <h3><i class="mdi mdi-lightbulb-on-outline"></i>Actions to take</h3>
            <div class="section-body" id="secActions">Nothing to report.</div>
          </section>
        </div>

        <!-- Visible summary -->
        <div id="modalSummary" class="prose prose-invert max-w-none whitespace-pre-wrap leading-relaxed"></div>
        <!-- Hidden alias for legacy code -->
        <div id="summary" class="sr-only"></div>
      </div>
    </div>
  </div>

  <!-- Bridge: provide legacy IDs (#title/#meta/#summary) and
     mirror their content ONE-WAY into the visible modal fields. -->
  <script>
    (function () {
      function ensureAlias(aliasId, primaryId) {
        const primary = document.getElementById(primaryId);
        if (!primary) return;

        let alias = document.getElementById(aliasId);
        if (!alias) {
          // Create a hidden alias element so old code can write to it
          alias = document.createElement(primary.tagName || 'div');
          alias.id = aliasId;
          alias.className = 'sr-only';
          // Put the alias just before the primary so queries still find it early
          primary.parentNode.insertBefore(alias, primary);
        }

        // ONE-WAY sync: whenever legacy alias changes, copy into the visible target
        const sync = () => { primary.innerHTML = alias.innerHTML; };
        new MutationObserver(sync).observe(alias, {
          childList: true,
          subtree: true,
          characterData: true
        });

        // Initial sync in case alias already has content set imperatively
        sync();
      }

      // Map legacy IDs -> visible IDs
      ensureAlias('title',   'modalTitle');
      ensureAlias('meta',    'modalMeta');
      ensureAlias('summary', 'modalSummary');
    })();
  </script>

  <!-- App logic -->
  <script src="static/app.js" defer></script>
</body>
</html>
