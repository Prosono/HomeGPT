<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>SMARTi Spectra</title>

  <!-- Preconnects for faster CDNs -->
  <link rel="preconnect" href="https://cdn.tailwindcss.com" crossorigin>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>

  <!-- UI libs -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
  <link rel="stylesheet" href="https://cdn.materialdesignicons.com/7.2.96/css/materialdesignicons.min.css">

  <!-- App styles -->
  <link rel="stylesheet" href="static/style.css" />
</head>
<body class="bg-gray-900 text-gray-200 font-sans antialiased selection:bg-indigo-600/30 selection:text-white">

  <!-- Animated background (aurora blobs) -->
  <div class="aurora" aria-hidden="true">
    <span class="blob b1"></span>
    <span class="blob b2"></span>
    <span class="blob b3"></span>
    <span class="blob b4"></span>
    <span class="blob b5"></span>
  </div>

  <main class="max-w-6xl mx-auto p-6">
    <div class="card rounded-xl shadow-xl p-8">
      <!-- Header with logo + wordmark -->
      <header class="mb-8">
        <a href="/" class="flex items-center justify-center gap-3 select-none" aria-label="Spectra Home">
          <picture>
            <source srcset="static/spectra-logo-dark.png" media="(prefers-color-scheme: dark)" />
            <img
              src="static/spectra-logo-light.png"
              alt="Spectra logo"
              class="h-12 w-auto"
              width="160"
              height="48"
              decoding="async"
            />
          </picture>
        </a>
        <p class="mt-2 text-center text-sm text-gray-400">Smart Living, Simplified</p>
      </header>

      <!-- Top controls bar -->
      <div class="flex flex-wrap items-center justify-between mb-6 gap-4">
        <div class="flex items-center gap-3">
          <button id="toggleMode" class="btn btn-ghost" aria-live="polite">
            <i class="mdi mdi-robot"></i>
            <span>Mode: <span id="modeName">Loading…</span></span>
          </button>
          <span class="chip" aria-live="polite">
            <i class="mdi mdi-cpu-64-bit"></i>
            <span id="modelName">Model</span>
          </span>
        </div>

        <div class="flex-1"></div>

        <div class="flex items-center gap-3 text-sm sm:text-base">
          <span class="chip" aria-live="polite">
            <i class="mdi mdi-bell-outline"></i><span id="eventCount">0 events</span>
          </span>
          <span class="chip" aria-live="polite">
            <i class="mdi mdi-clock-outline"></i><span id="sinceLast">—</span>
          </span>
        </div>

        <div class="flex items-center gap-3">
          <button id="btn-analyze-history" class="btn btn-ghost">
            <i class="mdi mdi-history"></i>Analyse history
          </button>
          <button id="runAnalysis" class="btn">
            <i class="mdi mdi-play"></i>Start New Analysis
          </button>
        </div>
      </div>

      <!-- History range dialog -->
      <dialog id="dlg-history" class="card rounded-xl p-6 text-gray-200">
        <form method="dialog">
          <h3 class="text-lg font-extrabold mb-3">Select time range</h3>
          <div id="history-options" class="flex flex-wrap gap-2 mb-4"><!-- buttons injected by JS --></div>
          <div class="text-right">
            <button value="cancel" class="btn btn-ghost">
              <i class="mdi mdi-close"></i>Cancel
            </button>
          </div>
        </form>
      </dialog>

      <!-- Progress bar -->
      <div class="mb-6">
        <div class="w-full bg-gray-700/70 h-3 rounded-full overflow-hidden">
          <div id="progressBar" class="bg-gradient-to-r from-purple-500 to-pink-500 h-3 rounded-full transition-all duration-500" style="width:0%"></div>
        </div>
      </div>

    <!-- Events (last 24h) -->
    <div class="mb-6">
      <div class="flex items-center justify-between mb-2">
        <h2>Events (last 24h)</h2>
        <div class="text-xs text-gray-400">Auto-extracted from analyses</div>
      </div>
      <div id="eventsList" class="divide-y divide-white/10 text-sm">
        <!-- app.js will fill this -->
      </div>
    </div>

      <!-- Analysis Heatmap -->
      <div class="mb-6">
        <div class="flex items-center justify-between mb-2">
          <h2>Analysis Heatmap</h2>
          <div class="flex items-center gap-3 text-sm">
            <div class="flex gap-2">
              <button class="chip" data-hm-range="24">24h</button>
              <button class="chip" data-hm-range="48">48h</button>
              <button class="chip" data-hm-range="168">7d</button>
            </div>
            <div class="flex items-center gap-2">
              <span>Min severity</span>
              <input id="hm-threshold" type="range" min="0" max="6" step="1" value="0" />
              <span id="hm-threshold-val" class="text-gray-400">0</span>
            </div>
            <div class="flex gap-2">
              <button class="chip" data-hm-filter="all">All</button>
              <button class="chip" data-hm-filter="security">Security</button>
              <button class="chip" data-hm-filter="comfort">Comfort</button>
              <button class="chip" data-hm-filter="energy">Energy</button>
              <button class="chip" data-hm-filter="anomalies">Anomalies</button>
            </div>
          </div>
        </div>
        <div id="analysisHeatmap" class="heatmap"></div>
        <div class="text-xs text-gray-400 mt-1">X: hour • Y: category • intensity = findings/severity</div>
      </div>

      <!-- Analyses grid -->
      <div id="analysisGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
    </div>
  </main>

  <!-- Modal overlay -->
  <div id="detailsOverlay" class="fixed inset-0 z-50 hidden">
    <div id="overlayBackdrop" class="absolute inset-0 bg-black/60"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
      <div class="card modal-panel rounded-xl shadow-2xl p-6 relative w-full max-w-5xl">
        <button id="modalClose" class="absolute top-3 right-3 text-gray-300 hover:text-white text-xl leading-none" aria-label="Close dialog">✕</button>

        <!-- Visible title/meta -->
        <div class="space-y-2 mb-4">
          <h2 id="modalTitle" class="text-2xl font-bold text-indigo-300">Analysis</h2>
          <div id="modalMeta" class="text-sm text-gray-400"></div>
        </div>

        <!-- Hidden aliases so old code using #title/#meta keeps working -->
        <h2 id="title" class="sr-only">Analysis</h2>
        <div id="meta" class="sr-only"></div>

        <!-- Optional hero -->
        <div class="modal-hero mb-6">
          <div class="hero-head">
            <i class="mdi mdi-home-analytics"></i>
            Daily Summary
          </div>
          <div class="hero-body" id="modalIntro">Latest insights for your home.</div>
        </div>

        <!-- Category layout -->
        <div class="modal-masonry hidden" id="modalMasonry">
          <section class="modal-section theme-security">
            <h3><i class="mdi mdi-shield-home-outline"></i>Security</h3>
            <div class="section-body" id="secSecurity">Nothing to report.</div>
          </section>

          <section class="modal-section theme-comfort">
            <h3><i class="mdi mdi-thermometer"></i>Comfort</h3>
            <div class="section-body" id="secComfort">Nothing to report.</div>
            <div class="section-chart"><canvas id="chartTemp"></canvas></div>
          </section>

          <section class="modal-section theme-energy">
            <h3><i class="mdi mdi-flash"></i>Energy</h3>
            <div class="section-body" id="secEnergy">Nothing to report.</div>
          </section>

          <section class="modal-section theme-anomalies">
            <h3><i class="mdi mdi-alert-decagram-outline"></i>Anomalies</h3>
            <div class="section-body" id="secAnomalies">Nothing to report.</div>
          </section>

          <section class="modal-section theme-reco">
            <h3><i class="mdi mdi-lightbulb-on-outline"></i>Actions to take</h3>
            <div class="section-body" id="secActions">Nothing to report.</div>
          </section>
        </div>

        <!-- Visible summary -->
        <div id="modalSummary" class="prose prose-invert max-w-none whitespace-pre-wrap leading-relaxed"></div>
        <!-- Hidden alias for legacy code -->
        <div id="summary" class="sr-only"></div>
      </div>
    </div>
  </div>

<!-- Feedback dialog -->
<dialog id="dlg-feedback" class="card rounded-xl p-6 text-gray-200 max-w-xl w-full">
  <form id="fb-form" method="dialog" class="space-y-4">
    <h3 class="text-lg font-extrabold">Send feedback</h3>

    <!-- Context surface -->
    <div class="text-xs text-gray-400 leading-relaxed" id="fb-context" aria-live="polite"></div>

    <!-- Kind -->
    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
      <label class="block">
        <span class="text-sm text-gray-300">Type</span>
        <select id="fb-kind" class="input mt-1 w-full">
          <option value="context">Context / Note</option>
          <option value="correction">Correction</option>
          <option value="ignore">Mark as noise</option>
        </select>
      </label>

      <label class="block">
        <span class="text-sm text-gray-300">Category</span>
        <select id="fb-category" class="input mt-1 w-full">
          <option>security</option>
          <option>comfort</option>
          <option>energy</option>
          <option>anomalies</option>
          <option>actions</option>
          <option>generic</option>
        </select>
      </label>
    </div>

    <!-- Note -->
    <label class="block">
      <span class="text-sm text-gray-300">Your note</span>
      <textarea id="fb-text" rows="4" class="input mt-1 w-full" placeholder="Add a short note that will help future analyses…"></textarea>
    </label>

    <!-- Hidden metadata (filled from JS) -->
    <input type="hidden" id="fb-analysis-id" />
    <input type="hidden" id="fb-event-id" />
    <input type="hidden" id="fb-body" />

    <!-- Buttons -->
    <div class="flex items-center justify-end gap-2 pt-2">
      <button type="button" id="fb-cancel" class="btn btn-ghost"><i class="mdi mdi-close"></i>Cancel</button>
      <button type="submit" id="fb-submit" class="btn"><i class="mdi mdi-send"></i>Submit</button>
    </div>

    <!-- Result area -->
    <div id="fb-result" class="text-sm text-gray-400"></div>
  </form>
</dialog>


<!-- Modal Overlay -->
<div id="detailsOverlay" class="overlay hidden">
  <div id="overlayBackdrop" class="overlay-backdrop"></div>
  <div class="overlay-content">
    <button id="modalClose" class="modal-close">&times;</button>
    <h2 id="modalTitle"></h2>
    <div id="modalMeta" class="modal-meta"></div>
    <div id="modalSummary" class="modal-body"></div>
  </div>
</div>
  <!-- Bridge for legacy IDs -->
  <script>
    (function () {
      function ensureAlias(aliasId, primaryId) {
        const primary = document.getElementById(primaryId);
        if (!primary) return;

        let alias = document.getElementById(aliasId);
        if (!alias) {
          alias = document.createElement(primary.tagName || 'div');
          alias.id = aliasId;
          alias.className = 'sr-only';
          primary.parentNode.insertBefore(alias, primary);
        }

        const sync = () => { primary.innerHTML = alias.innerHTML; };
        new MutationObserver(sync).observe(alias, {
          childList: true,
          subtree: true,
          characterData: true
        });

        sync();
      }

      ensureAlias('title',   'modalTitle');
      ensureAlias('meta',    'modalMeta');
      ensureAlias('summary', 'modalSummary');
    })();
  </script>

  <!-- App logic -->
  <script src="static/app.js" defer></script>
</body>
</html>
