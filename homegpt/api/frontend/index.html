<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>SMARTi Spectra</title>

  <!-- Preconnects -->
  <link rel="preconnect" href="https://cdn.tailwindcss.com" crossorigin>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>

  <!-- UI libs -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
  <link rel="stylesheet" href="https://cdn.materialdesignicons.com/7.2.96/css/materialdesignicons.min.css">

  <!-- App styles -->
  <link rel="stylesheet" href="static/style.css" />
</head>
<body class="bg-gray-900 text-gray-200 font-sans antialiased selection:bg-indigo-600/30 selection:text-white">

  <div id="particles-js" aria-hidden="true"></div>
  <!-- Animated background (aurora blobs) -->
  <div class="aurora" aria-hidden="true">
    <span class="blob b1"></span>
    <span class="blob b2"></span>
    <span class="blob b3"></span>
    <span class="blob b4"></span>
    <span class="blob b5"></span>
  </div>

  <main class="max-w-6xl mx-auto p-6">
    <div class="card rounded-xl shadow-xl p-8">
      <!-- Masthead -->
      <header class="masthead">
        <div class="mast-left">
          <button id="toggleMode" class="btn-ghost mast-pill" aria-live="polite">
            <i class="mdi mdi-robot"></i>
            <span id="modeName">passive</span>
          </button>

          <span class="chip mast-pill" aria-live="polite">
            <i class="mdi mdi-cpu-64-bit"></i>
            <span id="modelName">Model</span>
          </span>
        </div>

        <div class="mast-center">
          <a href="/" class="logo-wrap" aria-label="Spectra Home">
            <picture>
              <source srcset="static/spectra-logo-dark.png" media="(prefers-color-scheme: dark)" />
              <img src="static/spectra-logo-light.png" alt="Spectra logo" width="160" height="48" decoding="async" />
            </picture>
            <div class="tagline">Smart Living, Simplified</div>
          </a>
        </div>

        <div class="mast-right">
          <span class="stat" aria-live="polite">
            <i class="mdi mdi-bell-outline"></i>
            <span id="eventCount">0 events</span>
          </span>
          <span class="stat" aria-live="polite">
            <i class="mdi mdi-clock-outline"></i>
            <span id="sinceLast">—</span>
          </span>
        </div>
      </header>

      <!-- Primary actions -->
      <div class="actions-bar">
        <div class="actions-left">
          <button id="btn-analyze-history" class="btn-ghost lg">
            <i class="mdi mdi-history"></i>Analyse history
          </button>
        </div>
        <div class="actions-right">
          <button id="runAnalysis" class="btn">
            <i class="mdi mdi-play"></i>Start New Analysis
          </button>
          <button id="btn-manage-feedback" class="btn-ghost">
            <i class="mdi mdi-note-edit-outline"></i>Manage feedback
          </button>
        </div>
      </div>

      <!-- Progress bar -->
      <div class="mb-6">
        <div class="w-full bg-gray-700/70 h-3 rounded-full overflow-hidden">
          <div id="progressBar" class="bg-gradient-to-r from-purple-500 to-pink-500 h-3 rounded-full transition-all duration-500" style="width:0%"></div>
        </div>
      </div>

      <!-- Events (last 24h) -->
      <section class="mb-6">
        <div class="section-head">
          <h2>Events (last 24h)</h2>
          <div class="sub">Auto-extracted from analyses</div>
        </div>
        <div id="eventsList" class="text-sm"><!-- app.js injects .event-row items --></div>
        <div id="eventsPager"></div>
      </section>

      <!-- Feedback Manager -->
      <dialog id="dlg-manage-feedback" class="modal">
        <div class="modal-head">
          <h3 class="text-lg font-semibold">Feedback Manager</h3>
          <button id="fbm-close" class="chip">Close</button>
        </div>
      <div class="fbm-controls"></div>
        <div class="flex gap-2 my-2 fbm-toolbar">
          <input id="fbm-search" class="input" placeholder="Search notes, bodies, entities…" />
          <input id="fbm-entity" class="input" placeholder="Filter by entity_id (e.g. sensor.power)" />
          <select id="fbm-category" class="input">
            <option value="">All categories</option>
            <option>security</option><option>comfort</option><option>energy</option>
            <option>anomalies</option><option>presence</option>
          </select>
          <button id="fbm-refresh" class="chip">Refresh</button>
        </div>
      </div>
        <div id="fbm-list" class="space-y-2 max-h-[60vh] overflow-auto"></div>
      </dialog>

      <!-- Edit Feedback -->
      <dialog id="dlg-edit-feedback" class="modal">
        <h3 class="text-lg font-semibold mb-2">Edit feedback</h3>
        <input id="fbe-id" type="hidden" />
        <div class="text-sm text-gray-400 mb-2" id="fbe-meta"></div>
        <label class="block text-sm mb-1">Note</label>
        <textarea id="fbe-note" class="input" rows="4"></textarea>
        <label class="block text-sm mt-2 mb-1">Kind</label>
        <select id="fbe-kind" class="input">
          <option value="context">context</option>
          <option value="correction">correction</option>
          <option value="preference">preference</option>
        </select>
        <div class="mt-3 flex gap-2">
          <button id="fbe-save" class="chip">Save</button>
          <button id="fbe-delete" class="chip">Delete…</button>
          <button id="fbe-cancel" class="chip">Cancel</button>
        </div>
        <div id="fbe-result" class="text-sm mt-2"></div>
      </dialog>

      <!-- Analysis Heatmap -->
      <section class="mb-6">
        <div class="section-head">
          <h2>Analysis Heatmap</h2>
          <div class="heat-controls">
            <div class="flex gap-2">
              <button class="chip" data-hm-range="24">24h</button>
              <button class="chip" data-hm-range="48">48h</button>
              <button class="chip" data-hm-range="168">7d</button>
            </div>
            <div class="flex items-center gap-2">
              <span>Min severity</span>
              <input id="hm-threshold" type="range" min="0" max="6" step="1" value="0" />
              <span id="hm-threshold-val" class="text-gray-400">0</span>
            </div>
            <div class="flex gap-2">
              <button class="chip" data-hm-filter="all">All</button>
              <button class="chip" data-hm-filter="security">Security</button>
              <button class="chip" data-hm-filter="comfort">Comfort</button>
              <button class="chip" data-hm-filter="energy">Energy</button>
              <button class="chip" data-hm-filter="anomalies">Anomalies</button>
            </div>
          </div>
        </div>
        <div id="analysisHeatmap" class="heatmap"></div>
        <div class="text-xs text-gray-400 mt-1">X: hour • Y: category • intensity = findings/severity</div>
      </section>

      <!-- Analyses grid -->
      <div id="analysisGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
    </div>
  </main>

  <!-- Modal overlay (analysis details) -->
  <div id="detailsOverlay" class="fixed inset-0 z-50 hidden">
    <div id="overlayBackdrop" class="absolute inset-0 bg-black/60"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
      <div class="card modal-panel rounded-xl shadow-2xl p-6 relative w-full max-w-5xl">
        <button id="modalClose" class="absolute top-3 right-3 text-gray-300 hover:text-white text-xl leading-none" aria-label="Close dialog">✕</button>

        <div class="space-y-2 mb-4">
          <h2 id="modalTitle" class="text-2xl font-bold text-indigo-300">Analysis</h2>
          <div id="modalMeta" class="text-sm text-gray-400"></div>
        </div>

        <!-- Hidden aliases so old code using #title/#meta keeps working -->
        <h2 id="title" class="sr-only">Analysis</h2>
        <div id="meta" class="sr-only"></div>

        <!-- Optional hero -->
        <div class="modal-hero mb-6">
          <div class="hero-head">
            <i class="mdi mdi-home-analytics"></i>
            Daily Summary
          </div>
          <div class="hero-body" id="modalIntro">Latest insights for your home.</div>
        </div>

        <!-- Sections get injected -->
        <div id="modalSummary" class="prose prose-invert max-w-none whitespace-pre-wrap leading-relaxed"></div>
        <div id="summary" class="sr-only"></div>
      </div>
    </div>
  </div>

  <!-- Bridge for legacy IDs -->
  <script>
    (function () {
      function ensureAlias(aliasId, primaryId) {
        const primary = document.getElementById(primaryId);
        if (!primary) return;

        let alias = document.getElementById(aliasId);
        if (!alias) {
          alias = document.createElement(primary.tagName || 'div');
          alias.id = aliasId;
          alias.className = 'sr-only';
          primary.parentNode.insertBefore(alias, primary);
        }

        const sync = () => { primary.innerHTML = alias.innerHTML; };
        new MutationObserver(sync).observe(alias, {
          childList: true,
          subtree: true,
          characterData: true
        });

        sync();
      }
      ensureAlias('title','modalTitle');
      ensureAlias('meta','modalMeta');
      ensureAlias('summary','modalSummary');
    })();
  </script>

  <!-- particles.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>

  <script>
  (function () {
    // Respect reduced motion
    if (window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches) return;

    particlesJS('particles-js', {
      "particles": {
        "number": {
          "value": 70,
          "density": { "enable": true, "value_area": 900 }
        },
        "color": { "value": ["#60a5fa", "#a78bfa", "#22d3ee", "#ec4899"] }, // brand-y palette
        "shape": { "type": "circle" },
        "opacity": {
          "value": 0.35,
          "random": true
        },
        "size": {
          "value": 3,
          "random": true
        },
        "line_linked": {
          "enable": true,
          "distance": 130,
          "color": "#8093b6",
          "opacity": 0.25,
          "width": 1
        },
        "move": {
          "enable": true,
          "speed": 1.1,
          "direction": "none",
          "random": true,
          "straight": false,
          "out_mode": "out",
          "attract": { "enable": false }
        }
      },
      "interactivity": {
        "detect_on": "canvas",
        "events": {
          "onhover": { "enable": true, "mode": "grab" },
          "onclick": { "enable": true, "mode": "push" },
          "resize": true
        },
        "modes": {
          "grab": { "distance": 140, "line_linked": { "opacity": 0.45 } },
          "bubble": { "distance": 200, "size": 6, "duration": 2, "opacity": 0.4, "speed": 3 },
          "push": { "particles_nb": 3 }
        }
      },
      "retina_detect": true
    });
  })();
  </script>

  <!-- App logic -->
  <script src="static/app.js" defer></script>
</body>
</html>
